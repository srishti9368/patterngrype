trigger:
- main

pool:
  name: linux-grype   # self-hosted Linux agent

steps:
# Checkout code
- checkout: self

# Install .NET SDK
- task: UseDotNet@2
  displayName: "Install .NET SDK"
  inputs:
    packageType: 'sdk'
    version: '8.0.x'

# Restore dependencies
- script: |
    dotnet restore
  displayName: "Restore NuGet packages"

# Build project
- script: |
    dotnet build --configuration Release
  displayName: "Build C# project"

# Generate SBOM
- script: |
    syft dir:. -o cyclonedx-json > sbom.json
  displayName: "Generate SBOM (CycloneDX)"

# Scan SBOM with Grype
- script: |
    grype sbom:sbom.json --fail-on high
  displayName: "Grype Scan Using SBOM"

# Publish SBOM & Scan Evidence
- task: PublishPipelineArtifact@1
  displayName: "Publish SBOM & Grype Evidence"
  inputs:
    targetPath: .
    artifact: security-artifacts